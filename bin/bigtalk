#!/usr/bin/env python3
# This file is placed in the Public Domain.


"main program"


import os
import sys
import time


sys.path.insert(0, os.getcwd())


from bigtalk.clients import CLI
from bigtalk.command import Commands, addcmd, command
from bigtalk.configs import Config
from bigtalk.loggers import level
from bigtalk.message import Message
from bigtalk.methods import parse
from bigtalk.package import adddir, init, modules, scanner
from bigtalk.statics import SYSTEMD
from bigtalk.utility import check, forever, pipxdir, where, wrapped
from bigtalk.workdir import Workdir, moddir, pidfile, pidname, skel


"defines"


TXT = " ".join(sys.argv[1:])


"config"


Config.ignore = "rst,udp,web"
Config.level = "info"
Config.name = "bigtalk" 
Config.opts = ""
Config.version = 3


"clients"


class Line(CLI):

    def raw(self, text):
        "write to console."
        print(text.encode('utf-8', 'replace').decode("utf-8"))


class Console(Line):

    def callback(self, event):
        "wait for callback result."
        if not event.text:
            return
        super().callback(event)
        event.wait()

    def poll(self):
        "poll for an event."
        evt = Message()
        evt.text = input("> ")
        evt.kind = "command"
        return evt


"utility"


def banner():
    "hello."
    tme = time.ctime(time.time()).replace("  ", " ")
    print("%s %s %s since %s (%s)" % (
        Config.name.upper(),
        Config.version,
        Config.opts.strip().upper(),
        tme,
        Config.level.upper()
    ))
    sys.stdout.flush()


def boot(cfg):
    "in the beginning."
    Workdir.wdr = Workdir.wdr or os.path.expanduser(f"~/.{cfg.name}")
    skel()
    parse(cfg, TXT)
    level(cfg.sets.level or cfg.level or "info")
    adddir(f"{Config.name}.modules", os.path.join(where(Config), "modules"))
    adddir("modules", moddir())
    if "m" in Config.opts:
        adddir("mods", "mods")


def daemon(verbose=False, nochdir=False):
    "run in the background."
    pid = os.fork()
    if pid != 0:
        os._exit(0)
    os.setsid()
    pid2 = os.fork()
    if pid2 != 0:
        os._exit(0)
    if not verbose:
        with open('/dev/null', 'r', encoding="utf-8") as sis:
            os.dup2(sis.fileno(), sys.stdin.fileno())
        with open('/dev/null', 'a+', encoding="utf-8") as sos:
            os.dup2(sos.fileno(), sys.stdout.fileno())
        with open('/dev/null', 'a+', encoding="utf-8") as ses:
            os.dup2(ses.fileno(), sys.stderr.fileno())
    if not nochdir:
        os.umask(0)
        os.chdir("/")
    os.nice(10)


def privileges():
    "drop privileges."
    import getpass
    import pwd
    pwnam2 = pwd.getpwnam(getpass.getuser())
    os.setgid(pwnam2.pw_gid)
    os.setuid(pwnam2.pw_uid)


def wrap(func):
    "restore console."
    import termios
    old = None
    try:
        old = termios.tcgetattr(sys.stdin.fileno())
    except termios.error:
        pass
    try:
        wrapped(func)
    finally:
        pass
    if old:
        termios.tcsetattr(sys.stdin.fileno(), termios.TCSADRAIN, old)


"scripts"


def background():
    "background script."
    daemon(check("v", TXT), check("m", TXT))
    privileges()
    boot(Config)
    pidfile(pidname(Config.name))
    addcmd(cmd, mod, ver)
    scanner(modules(Config.ignore))
    init(modules(Config.ignore))
    forever()


def console():
    "console script."
    import readline
    readline.redisplay()
    boot(Config)
    if "v" in Config.opts:
        banner()
    scanner(modules(Config.ignore))
    addcmd(cmd, mod, ver)
    mds = Config.sets.init
    if not mds and "a" in Config.opts:
        mds = modules(Config.ignore)
    init(mds, "w" in Config.opts)
    csl = Console()
    csl.start()
    forever()

def control():
    "cli script."
    if len(sys.argv) == 1:
        return
    boot(Config)
    scanner(modules(Config.ignore))
    addcmd(cmd, exa, mod, srv, ver)
    cli = Line()
    evt = Message()
    evt.orig = repr(cli)
    evt.text = " ".join(sys.argv[1:])
    evt.type = "command"
    command(evt)
    evt.wait()


def service():
    "service script."
    privileges()
    boot(Config)
    banner()
    pidfile(pidname(Config.name))
    addcmd(cmd, mod, ver)
    scanner(modules(Config.ignore))
    init(modules(Config.ignore))
    forever()


"commands"


def cmd(event):
    "list available commands."
    event.reply(",".join(sorted(Commands.names or Commands.cmds)))


def exa(event):
    "location of examples."
    path = pipxdir(Config.name)
    if not os.path.exists(os.path.expanduser(path)):
        event.reply("pipx examples directory is not there.")
        return
    event.reply(f"examples are at {path}")


def mod(event):
    "list available commands."
    event.reply(modules())


def srv(event):
    "generate systemd service file."
    import getpass
    name = getpass.getuser()
    event.reply(SYSTEMD % (Config.name.upper(), name, name, name, Config.name))


def ver(event):
    "show version."
    event.reply(f"{Config.name.upper()} {Config.version} {Config.opts.upper()}")


"runtime"


def main():
    "main"
    if check("d", TXT):
        background()
    elif check("c", TXT):
        wrap(console)
    elif check("s", TXT):
        wrapped(service)
    else:
        wrapped(control)


if __name__ == "__main__":
    main()
